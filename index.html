<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VibeSync</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --wa-header-bg: #005c97; --wa-accent-blue: #34B7F1; --wa-message-out-bg: #e1f6fb;
            --wa-message-in-bg: #ffffff; --wa-app-bg: #f0f2f5; --wa-chat-bg: #e5ddd5;
            --wa-icon-color: #f0f2f5; --wa-text-primary: #111b21; --wa-text-secondary: #667781;
            --wa-border-color: #e9edef; --wa-active-tab-indicator: var(--wa-accent-blue);
            --wa-button-color: #008069; --wa-link-color: #00a8e8; --wa-shadow: rgba(17, 27, 33, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; overflow: hidden; background-color: #d1d7db; }
        body { color: var(--wa-text-primary); font-family: 'Roboto', sans-serif; display: flex; justify-content: center; align-items: center; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; } ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .icon-btn { background: none; border: none; color: var(--wa-icon-color); cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .icon-btn:hover { background-color: rgba(255,255,255,0.1); }
        .icon-btn svg { width: 24px; height: 24px; fill: currentColor; }
        #app-container { width: 100%; height: 100%; max-width: 450px; max-height: 950px; background-color: var(--wa-app-bg); box-shadow: 0 12px 28px 0 var(--wa-shadow); display: flex; flex-direction: column; overflow: hidden; position: relative; border-radius: 8px; }
        .view { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; background-color: var(--wa-message-in-bg); }
        #auth-view { justify-content: center; padding: 40px 20px; }
        .app-title { font-size: 36px; font-weight: 700; color: var(--wa-header-bg); margin-bottom: 40px; text-align: center; }
        .auth-form { width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 16px; }
        .auth-form input { border-radius: 8px; border: 1px solid #ccc; background-color: #fff; color: var(--wa-text-primary); padding: 14px; font-family: 'Roboto', sans-serif; font-size: 16px; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; }
        .auth-form input:focus { outline: none; border-color: var(--wa-header-bg); box-shadow: 0 0 0 2px rgba(0, 92, 151, 0.2); }
        .auth-form button { border-radius: 8px; background-color: var(--wa-header-bg); color: white; font-weight: 500; font-family: 'Roboto', sans-serif; font-size: 16px; border: none; padding: 14px; cursor: pointer; width: 100%; transition: background-color 0.2s; }
        .auth-form button:hover { background-color: #004c7a; }
        .form-switch-text { color: var(--wa-text-secondary); font-size: 14px; text-align: center; margin-top: 10px; }
        .form-switch-text a { color: var(--wa-link-color); text-decoration: none; cursor: pointer; font-weight: 500; }
        .error-message { color: #d93025; font-size: 13px; text-align: center; min-height: 20px; }
        #main-view { display: none; }
        header.main-header { width: 100%; background-color: var(--wa-header-bg); padding: 10px 15px 0; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 5; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 20px; font-weight: 500; color: var(--wa-icon-color); }
        .header-actions { display: flex; gap: 10px; }
        .header-nav { display: flex; justify-content: space-around; margin-top: 15px; }
        .nav-tab { background: none; border: none; color: rgba(255, 255, 255, 0.7); font-family: 'Roboto', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; padding: 12px 16px; flex-grow: 1; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; position: relative; text-transform: uppercase; }
        .nav-tab.active { color: var(--wa-active-tab-indicator); border-bottom-color: var(--wa-active-tab-indicator); }
        .badge { position: absolute; top: 8px; right: 15%; background-color: var(--wa-active-tab-indicator); color: white; border-radius: 10px; font-size: 11px; padding: 2px 6px; font-weight: 500; display: none; }
        main { width: 100%; flex-grow: 1; overflow-y: auto; background-color: #fff; }
        .content-panel { display: none; } .content-panel.active { display: block; }
        .list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; background-color: #fff; border-bottom: 1px solid var(--wa-border-color); transition: background-color 0.2s; }
        .list-item:hover { background-color: var(--wa-app-bg); } .list-item:last-child { border-bottom: none; }
        .list-item-emoji { font-size: 24px; margin-right: 15px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background-color: #ccc; border-radius: 50%; }
        .list-item-details { flex-grow: 1; } .list-item-name { font-weight: 500; font-size: 17px; margin-bottom: 2px; }
        .list-item-subtext { font-size: 14px; color: var(--wa-text-secondary); }
        .list-item-actions { display: flex; gap: 10px; }
        .list-item-actions button { background-color: var(--wa-accent-blue); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .list-item-actions button.reject { background-color: var(--wa-text-secondary); }
        #chat-view { display: none; position: absolute; top: 0; left: 0; z-index: 10; background-color: var(--wa-chat-bg); background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23bdbdbd' fill-opacity='0.15' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E"); }
        header.chat-header { width: 100%; padding: 8px 10px; display: flex; align-items: center; gap: 10px; background-color: var(--wa-header-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; z-index: 1; }
        header.chat-header .icon-btn { color: var(--wa-icon-color); }
        #chat-header-info { text-align: left; flex-grow:1; color: var(--wa-icon-color); }
        #chat-header-emoji { width:40px; height: 40px; font-size: 22px; background-color: #ccc; }
        #chat-header-name { font-weight: 500; font-size: 17px; }
        .chat-header-actions { display:flex; align-items: center; gap: 5px; }
        #chat-messages { flex-grow: 1; width: 100%; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 3px; }
        .message-bubble { max-width: 80%; padding: 8px 12px; border-radius: 8px; margin-bottom: 2px; word-wrap: break-word; line-height: 1.4; box-shadow: 0 1px 1px var(--wa-shadow); position: relative; }
        .message-sent { background-color: var(--wa-message-out-bg); align-self: flex-end; border-bottom-right-radius: 0; }
        .message-received { background-color: var(--wa-message-in-bg); align-self: flex-start; border-bottom-left-radius: 0; }
        #chat-input-container { width: 100%; padding: 8px 12px; display: flex; gap: 10px; background-color: var(--wa-app-bg); align-items: flex-end; flex-shrink: 0; }
        #chat-input { flex-grow: 1; border: none; background-color: #fff; color: var(--wa-text-primary); padding: 12px 18px; border-radius: 22px; font-family: 'Roboto', sans-serif; font-size: 15px; max-height: 100px; resize: none; }
        #chat-input:focus { outline: none; }
        #chat-send-btn { background: var(--wa-accent-blue); border: none; color: white; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-bottom: 2px; transition: background-color 0.2s; }
        #chat-send-btn:hover { background-color: #2aa3e0; }
        #chat-send-btn svg { width: 24px; height: 24px; fill: white; margin-left: 2px; }
        .call-view { display: none; position: absolute; top: 0; left: 0; z-index: 20; background-color: #222; justify-content: center; align-items: center; }
        #video-call-view { background-color: black; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        #local-video-canvas { width: 100px; height: 140px; position: absolute; bottom: 120px; right: 20px; border: 2px solid rgba(255,255,255,0.5); border-radius: 10px; cursor: move; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .call-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 60px 20px 50px; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent 40%, transparent 60%, rgba(0,0,0,0.7)); }
        .caller-info { text-align: center; color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .caller-info .emoji { font-size: 80px; } .caller-info .name { font-size: 28px; font-weight: 500; margin-top: 10px; } .caller-info .status { font-size: 16px; color: #ccc; margin-top: 5px; }
        .call-controls { display: flex; gap: 30px; }
        .call-controls button { width: 70px; height: 70px; border-radius: 50%; border: none; color: white; font-family: 'Roboto', sans-serif; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .end-call-btn { background-color: #e91e63; } .accept-call-btn { background-color: #4CAF50; }
        .modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 30; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-content h2 { text-align: center; color: var(--wa-header-bg); font-weight: 500; }
        .modal-content input { border-radius: 8px; border: 1px solid #ccc; background-color: var(--wa-app-bg); color: var(--wa-text-primary); padding: 12px 15px; font-family: 'Roboto', sans-serif; font-size: 16px; width: 100%; }
        .modal-content button { border-radius: 8px; background-color: var(--wa-header-bg); color: white; font-weight: 500; font-family: 'Roboto', sans-serif; font-size: 16px; border: none; padding: 12px 20px; cursor: pointer; width: 100%; }
        .modal-content button.secondary { background-color: var(--wa-text-secondary); }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        #incoming-call-modal .caller-info { color: var(--wa-text-primary); text-shadow: none; padding-bottom: 20px; }
        #profile-info-display p { padding: 5px 0; font-size: 16px; } #profile-info-display strong { color: var(--wa-header-bg); font-weight: 500; }
        #blocked-users-list .list-item { background-color: transparent; }
        #blocked-users-list .list-item-actions button { background-color: var(--wa-accent-blue); font-size: 12px; padding: 6px 10px; }
        #search-modal .modal-content { height: 80%; }
        #search-results { flex-grow: 1; overflow-y: auto; margin-top: 15px; }
        .suggestion-item { display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        .suggestion-item img { width: 50px; height: 50px; margin-right: 12px; border-radius: 4px; object-fit: cover; }
        #music-player-bar { display: none; flex-shrink: 0; width: 100%; padding: 8px 12px; background-color: #fff; border-top: 1px solid var(--wa-border-color); }
        #music-info-wrapper { display: flex; align-items: center; gap: 10px; flex-grow: 1; overflow: hidden;}
        #music-info { display: flex; align-items: center; gap: 10px; }
        #music-info img { width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0; }
        #music-title { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #music-controls-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; }
        #music-main-controls { display: flex; width: 100%; align-items: center; }
        #music-controls { display: flex; align-items: center; justify-content: center; gap: 15px; }
        #music-controls button { background: none; border: none; cursor: pointer; } #music-controls svg { width: 28px; height: 28px; }
        #music-remove-btn { background: none; border: none; cursor: pointer; margin-left: auto; padding: 5px; } #music-remove-btn svg { width: 20px; height: 20px; fill: var(--wa-text-secondary); }
        #music-progress-container { width: 100%; height: 4px; background-color: #ddd; cursor: pointer; margin-top: 8px; border-radius: 2px; }
        #music-progress-bar { width: 0; height: 100%; background-color: var(--wa-accent-blue); border-radius: 2px; }

        /* Video Watch View Styles */
        #video-watch-view { display: none; background-color: #000; z-index: 15; position: relative; }
        #video-watch-player-container { width: 100%; height: auto; aspect-ratio: 16/9; background-color: #000; }
        #video-watch-player { width: 100%; height: 100%; }
        .video-watch-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .video-watch-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent); }
        .video-watch-header h3 { color: white; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #close-watch-view-btn { color: white; }
        #reaction-bar { display: none; justify-content: center; align-items: center; gap: 15px; padding: 15px; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); }
        #reaction-bar button { background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 28px; cursor: pointer; backdrop-filter: blur(5px); }
        #video-watch-view.fullscreen #reaction-bar { display: flex; }
        #reaction-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; }
        .reaction-emoji { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; animation: pop-and-fade 2s ease-out forwards; }
        @keyframes pop-and-fade {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            50% { transform: translate(-50%, -60%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -70%) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Auth View -->
        <div id="auth-view" class="view">
            <h1 class="app-title">VibeSync</h1>
            <form id="login-form" class="auth-form"><div id="login-error" class="error-message"></div><input type="email" id="login-email" placeholder="Email" required><input type="password" id="login-password" placeholder="Password" required><button type="submit">Log In</button><p class="form-switch-text">Don't have an account? <a id="show-signup">Sign up</a></p></form>
            <form id="signup-form" class="auth-form" style="display: none;"><div id="signup-error" class="error-message"></div><input type="email" id="signup-email" placeholder="Email" required><input type="password" id="signup-password" placeholder="Password" required><button type="submit">Sign Up</button><p class="form-switch-text">Already have an account? <a id="show-login">Log in</a></p></form>
        </div>

        <!-- Main App View -->
        <div id="main-view" class="view">
            <header class="main-header"><div class="header-top"><span class="header-title">VibeSync</span><div class="header-actions"><button id="add-friend-btn" class="icon-btn" title="Add Friend"><svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg></button><button id="menu-btn" class="icon-btn" title="Profile & Settings"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"></path></svg></button></div></div><nav class="header-nav"><button id="nav-home" class="nav-tab active">Chats <span id="home-badge" class="badge"></span></button><button id="nav-notifications" class="nav-tab">Updates <span id="notifications-badge" class="badge"></span></button><button id="nav-calls" class="nav-tab">Calls</button></nav></header>
            <main id="main-content"><div id="home-content" class="content-panel active"><div id="contact-list"></div></div><div id="notifications-content" class="content-panel"><div id="notification-list"></div></div><div id="calls-content" class="content-panel"><div id="call-log-list"></div></div></main>
        </div>
        
        <!-- Chat View -->
        <div id="chat-view" class="view">
            <header class="chat-header"><button id="back-to-main-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg></button><div id="chat-header-emoji" class="list-item-emoji"></div><div id="chat-header-info"><span id="chat-header-name"></span></div><div class="chat-header-actions"><button id="movie-search-btn" class="icon-btn" title="Watch Video Together"><svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12zM9 10.5l6 4.5-6 4.5v-9z"></path></svg></button><button id="music-search-btn" class="icon-btn" title="Listen to Music"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"></path></svg></button><button id="voice-call-btn" class="icon-btn" title="Voice Call"><svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"></path></svg></button><button id="video-call-btn" class="icon-btn" title="Video Call"><svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"></path></svg></button><button id="chat-more-btn" class="icon-btn" title="More options"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg></button></div></header>
            <div id="chat-messages"></div>
            <div id="music-player-bar"><div id="music-controls-wrapper"><div id="music-main-controls"><div id="music-info-wrapper"><div id="music-info"><img id="music-thumbnail" src="" alt="thumbnail"><span id="music-title"></span></div></div><div id="music-controls"><button id="music-play-pause-btn"><svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg><svg id="pause-icon" style="display:none;" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg></button></div><button id="music-remove-btn" title="Remove song"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></button></div><div id="music-progress-container"><div id="music-progress-bar"></div></div></div></div>
            <div id="chat-input-container"><input type="text" id="chat-input" placeholder="Message"><button id="chat-send-btn"><svg viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button></div>
        </div>
        
        <!-- Video Watch View -->
        <div id="video-watch-view" class="view">
            <div id="video-watch-player-container">
                <div id="video-watch-player"></div>
            </div>
            <div class="video-watch-overlay">
                <div class="video-watch-header">
                    <h3 id="video-watch-title"></h3>
                    <div>
                        <button id="fullscreen-btn" class="icon-btn" title="Fullscreen"><svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg></button>
                        <button id="close-watch-view-btn" class="icon-btn" title="Close"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></button>
                    </div>
                </div>
                <div id="reaction-bar">
                    <button>👍</button><button>😂</button><button>❤️</button><button>😮</button><button>😢</button>
                </div>
            </div>
            <div id="reaction-container"></div>
        </div>

        <!-- Call Views -->
        <div id="video-call-view" class="view call-view"><video id="remote-video" autoplay playsinline></video><canvas id="local-video-canvas"></canvas><div class="call-overlay"><div id="video-caller-info" class="caller-info"><div class="emoji"></div><div class="name"></div><div class="status"></div></div><div class="call-controls"><button id="end-video-call-btn" class="end-call-btn"><svg fill="white" viewBox="0 0 24 24" width="36" height="36"><path d="M12 9c-1.6 0-3.15.25-4.63.72L12 14.29l4.63-4.57A9.94 9.94 0 0 0 12 9zm7.36-1.56a14.33 14.33 0 0 1-1.39 1.39L12 14.77l-5.97-5.94a14.33 14.33 0 0 1-1.39-1.39A10.05 10.05 0 0 1 12 7c2.18 0 4.23.7 5.95 1.88l-1.42 1.42C15.4 9.56 13.77 9 12 9c-1.6 0-3.15.25-4.63.72L12 14.29l7.36-7.29zM3.41 1.86L2 3.27l2.91 2.91A14.2 14.2 0 0 0 3.04 7.64L4.4 6.28a12.18 12.18 0 0 1 1.36-1.12L2.01 1.41z"></path></svg></button></div></div></div>
        <div id="voice-call-view" class="view call-view"><audio id="remote-audio" autoplay playsinline></audio><div class="call-overlay"><div id="voice-caller-info" class="caller-info"><div class="emoji"></div><div class="name"></div><div class="status"></div></div><div class="call-controls"><button id="end-voice-call-btn" class="end-call-btn"><svg fill="white" viewBox="0 0 24 24" width="36" height="36"><path d="M12 9c-1.6 0-3.15.25-4.63.72L12 14.29l4.63-4.57A9.94 9.94 0 0 0 12 9zm7.36-1.56a14.33 14.33 0 0 1-1.39 1.39L12 14.77l-5.97-5.94a14.33 14.33 0 0 1-1.39-1.39A10.05 10.05 0 0 1 12 7c2.18 0 4.23.7 5.95 1.88l-1.42 1.42C15.4 9.56 13.77 9 12 9c-1.6 0-3.15.25-4.63.72L12 14.29l7.36-7.29zM3.41 1.86L2 3.27l2.91 2.91A14.2 14.2 0 0 0 3.04 7.64L4.4 6.28a12.18 12.18 0 0 1 1.36-1.12L2.01 1.41z"></path></svg></button></div></div></div>

        <!-- Modals -->
        <div id="profile-setup-modal" class="modal"><div class="modal-content"><h2>Set up your Profile</h2><input type="text" id="profile-name-input" placeholder="Your Name" required><input type="text" id="profile-emoji-input" placeholder="Emoji (e.g., 😊)" maxlength="2" required><button id="save-profile-btn">Save Profile</button></div></div>
        <div id="add-friend-modal" class="modal"><div class="modal-content"><h2>Add Friend</h2><p>Enter your friend's VibeSync ID</p><input type="text" id="add-friend-id-input" placeholder="eg: Abhi31"><div class="modal-actions"><button id="close-add-friend-modal-btn" class="secondary">Cancel</button><button id="send-friend-request-btn">Send Request</button></div></div></div>
        <div id="profile-view-modal" class="modal"><div class="modal-content"><h2>Your Profile</h2><div id="profile-info-display"></div><div id="profile-edit-form" style="display:none;"><input type="text" id="edit-profile-name"><input type="text" id="edit-profile-emoji" maxlength="2"></div><div class="modal-actions"><button id="edit-profile-btn">Edit</button><button id="save-profile-changes-btn" style="display:none;">Save</button></div><div id="blocked-users-section"><h3>Blocked Users</h3><div id="blocked-users-list" style="max-height: 120px; overflow-y: auto;"></div></div><button id="logout-btn" style="margin-top: 15px; background-color: #d93025;">Logout</button><button id="close-profile-modal-btn" class="secondary">Close</button></div></div>
        <div id="incoming-call-modal" class="modal"><div class="modal-content"><h2>Incoming Call</h2><div id="incoming-caller-info" class="caller-info"><div class="emoji"></div><div class="name"></div></div><div class="modal-actions" style="justify-content:space-around; padding: 10px 0;"><button id="reject-call-btn" class="end-call-btn">Reject</button><button id="accept-call-btn" class="accept-call-btn">Accept</button></div></div></div>
        <div id="search-modal" class="modal"><div class="modal-content"><h2>Search</h2><input type="text" id="search-input" placeholder="Search for..."><div id="search-results"></div><div class="modal-actions"><button id="close-search-modal-btn" class="secondary">Close</button></div></div></div>
        <div id="confirm-modal" class="modal"><div class="modal-content"><h2 id="confirm-modal-title">Are you sure?</h2><p id="confirm-modal-message" style="text-align: center; color: var(--wa-text-secondary);"></p><div class="modal-actions" style="justify-content: center;"><button id="confirm-modal-cancel-btn" class="secondary">Cancel</button><button id="confirm-modal-confirm-btn" style="background-color: #d93025;">Confirm</button></div></div></div>
    </div>
    
    <audio id="ringtone" loop><source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA" type="audio/wav"></audio>
    <div id="music-player-container" style="position: fixed; top: -9999px; left: -9999px;"></div>
    <video id="local-video-hidden" autoplay playsinline muted style="display:none;"></video>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtG93LedHFijs6awzaukZdcdPLDpnYZwI",
            authDomain: "calling-8fda3.firebaseapp.com",
            databaseURL: "https://calling-8fda3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "calling-8fda3",
            storageBucket: "calling-8fda3.firebasestorage.app",
            messagingSenderId: "330999548038",
            appId: "1:330999548038:web:6658e0b95ff15595166907"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- GLOBAL STATE ---
        let currentUser = null, currentChatPartner = null, currentCallData = null, currentChatId = null;
        let peerConnection, localStream, remoteStream;
        const stunServers = { iceServers: [ { urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' } ] };
        let musicPlayer, videoWatchPlayer, musicUpdateInterval;
        let localVideoCanvas, canvasCtx, localVideoHidden, animationFrameId, canvasStream;
        let searchType = 'music'; // 'music' or 'movie'

        // --- UI ELEMENT SELECTORS ---
        const allViews = document.querySelectorAll('.view');
        const ringtone = document.getElementById('ringtone');

        // --- UTILITY & SETUP ---
        const showView = (viewId) => { allViews.forEach(v => v.style.display = 'none'); document.getElementById(viewId).style.display = 'flex'; };
        const showModal = (modalId, show = true) => { document.getElementById(modalId).style.display = show ? 'flex' : 'none'; };
        const getChatId = (uid1, uid2) => [uid1, uid2].sort().join('_');
        async function createUniqueUserId(name) {
            const baseId = name.replace(/[^a-zA-Z0-9]/g, '') || 'user';
            let finalId = ''; let isUnique = false;
            while (!isUnique) {
                const randomNumber = Math.floor(10 + Math.random() * 90);
                finalId = baseId + randomNumber;
                const snapshot = await db.ref('users').orderByChild('jgId').equalTo(finalId).once('value');
                if (!snapshot.exists()) { isUnique = true; }
            } return finalId;
        }
        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirm-modal-message').textContent = message;
            const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true); 
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => { onConfirm(); showModal('confirm-modal', false); });
            document.getElementById('confirm-modal-cancel-btn').onclick = () => showModal('confirm-modal', false);
            showModal('confirm-modal', true);
        }

        // --- AUTHENTICATION & PROFILE ---
        auth.onAuthStateChanged(async (user) => { if (user) { db.ref(`users/${user.uid}`).on('value', (snapshot) => { if (snapshot.exists()) { const wasNull = currentUser === null; currentUser = { uid: user.uid, ...snapshot.val() }; if(wasNull) initializeApp(); showView('main-view'); } else { showModal('profile-setup-modal'); } }); } else { currentUser = null; showView('auth-view'); } });
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(error => document.getElementById('login-error').textContent = error.message); });
        document.getElementById('signup-form').addEventListener('submit', (e) => { e.preventDefault(); auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value).then(userCredential => { currentUser = { uid: userCredential.user.uid, email: userCredential.user.email }; showModal('profile-setup-modal'); }).catch(error => document.getElementById('signup-error').textContent = error.message); });
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut(); showModal('profile-view-modal', false); });
        document.getElementById('show-signup').addEventListener('click', () => { document.getElementById('login-form').style.display = 'none'; document.getElementById('signup-form').style.display = 'flex'; });
        document.getElementById('show-login').addEventListener('click', () => { document.getElementById('signup-form').style.display = 'none'; document.getElementById('login-form').style.display = 'flex'; });
        document.getElementById('save-profile-btn').addEventListener('click', async () => { const name = document.getElementById('profile-name-input').value.trim(); const emoji = document.getElementById('profile-emoji-input').value.trim(); if (!name || !emoji) return alert('Name and Emoji are required.'); const jgId = await createUniqueUserId(name); const profileData = { name, emoji, jgId, email: currentUser.email, contacts: {}, blocked: {} }; db.ref(`users/${currentUser.uid}`).set(profileData).then(() => showModal('profile-setup-modal', false)); });
        function initializeApp() { listenForContacts(); listenForFriendRequests(); listenForIncomingCalls(); listenForUnreadMessages(); renderCallLogs(); localVideoCanvas = document.getElementById('local-video-canvas'); canvasCtx = localVideoCanvas.getContext('2d'); localVideoHidden = document.getElementById('local-video-hidden'); }

        // --- NAVIGATION & CHAT LIFECYCLE ---
        function showPanel(panelId) { document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active')); document.getElementById(panelId).classList.add('active'); document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active')); if(panelId === 'home-content') document.getElementById('nav-home').classList.add('active'); if(panelId === 'notifications-content') document.getElementById('nav-notifications').classList.add('active'); if(panelId === 'calls-content') document.getElementById('nav-calls').classList.add('active'); }
        document.getElementById('nav-home').addEventListener('click', () => showPanel('home-content'));
        document.getElementById('nav-notifications').addEventListener('click', () => showPanel('notifications-content'));
        document.getElementById('nav-calls').addEventListener('click', () => showPanel('calls-content'));
        document.getElementById('menu-btn').addEventListener('click', () => showProfileModal());
        document.getElementById('add-friend-btn').addEventListener('click', () => showModal('add-friend-modal'));
        document.getElementById('close-add-friend-modal-btn').addEventListener('click', () => showModal('add-friend-modal', false));
        document.getElementById('back-to-main-btn').addEventListener('click', () => {
            showView('main-view');
            if (window.currentChatListener) db.ref(window.currentChatListener.path).off('child_added', window.currentChatListener.callback);
            if (currentChatId) {
                db.ref(`musicState/${currentChatId}`).off();
                db.ref(`videoState/${currentChatId}`).off();
                db.ref(`reactions/${currentChatId}`).off();
            }
            if (musicPlayer && typeof musicPlayer.stopVideo === 'function') musicPlayer.stopVideo();
            document.getElementById('music-player-bar').style.display = 'none';
            clearInterval(musicUpdateInterval);
            currentChatPartner = null; currentChatId = null;
        });
        
        async function openChat(partnerUid, partnerData) {
            if (currentUser.blocked && currentUser.blocked[partnerUid]) return alert(`This user is blocked.`);
            currentChatPartner = { uid: partnerUid, ...partnerData };
            currentChatId = getChatId(currentUser.uid, partnerUid);
            document.getElementById('chat-header-emoji').textContent = partnerData.emoji;
            document.getElementById('chat-header-name').textContent = partnerData.name;
            document.getElementById('chat-messages').innerHTML = '';
            db.ref(`unreadCounts/${currentUser.uid}/${currentChatId}`).set(0);

            const messagesRef = db.ref(`messages/${currentChatId}`).limitToLast(50);
            window.currentChatListener = { path: `messages/${currentChatId}`, callback: messagesRef.on('child_added', snapshot => { const msg = snapshot.val(); const div = document.createElement('div'); div.textContent = msg.text; div.className = 'message-bubble ' + (msg.sender === currentUser.uid ? 'message-sent' : 'message-received'); const chatMessages = document.getElementById('chat-messages'); chatMessages.appendChild(div); chatMessages.scrollTop = chatMessages.scrollHeight; })};
            
            initMusicSync(currentChatId);
            initVideoWatchSync(currentChatId);
            listenForReactions(currentChatId);
            showView('chat-view');
        }

        // --- FRIEND SYSTEM --- (Unchanged)
        document.getElementById('send-friend-request-btn').addEventListener('click', () => { const friendId = document.getElementById('add-friend-id-input').value.trim(); if (!friendId) return; db.ref('users').orderByChild('jgId').equalTo(friendId).once('value', snapshot => { if (snapshot.exists()) { const friendUid = Object.keys(snapshot.val())[0]; if(friendUid === currentUser.uid) return alert("You can't add yourself."); const request = { name: currentUser.name, emoji: currentUser.emoji, type: 'incoming' }; db.ref(`requests/${friendUid}/${currentUser.uid}`).set(request).then(() => { alert('Friend request sent!'); showModal('add-friend-modal', false); document.getElementById('add-friend-id-input').value = ''; }); } else { alert('User not found.'); } }); });
        function listenForFriendRequests() { db.ref(`requests/${currentUser.uid}`).on('value', snapshot => { const list = document.getElementById('notification-list'); list.innerHTML = ''; let incomingRequestCount = 0; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const request = childSnapshot.val(); const fromUid = childSnapshot.key; if (currentUser.blocked && currentUser.blocked[fromUid]) return; const div = document.createElement('div'); div.className = 'list-item'; div.style.cursor = 'default'; const type = request.type || 'incoming'; switch (type) { case 'incoming': incomingRequestCount++; div.innerHTML = `<div class="list-item-emoji">${request.emoji}</div><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Wants to be your friend</div></div><div class="list-item-actions"><button onclick="handleFriendRequest('${fromUid}', true)">Accept</button><button class="reject" onclick="handleFriendRequest('${fromUid}', false)">Reject</button></div>`; break; case 'accepted': div.innerHTML = `<div class="list-item-emoji">${request.emoji}</div><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Accepted your friend request.</div></div><div class="list-item-actions"><button class="reject" onclick="dismissNotification('${fromUid}')">Dismiss</button></div>`; break; case 'rejected': div.innerHTML = `<div class="list-item-emoji">${request.emoji}</div><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Declined your friend request.</div></div><div class="list-item-actions"><button class="reject" onclick="dismissNotification('${fromUid}')">Dismiss</button></div>`; break; } if (div.innerHTML) list.appendChild(div); }); } if (list.childElementCount === 0) list.innerHTML = '<p style="text-align:center; color: #667781; padding: 40px 20px;">No new updates.</p>'; const badge = document.getElementById('notifications-badge'); badge.textContent = incomingRequestCount; badge.style.display = incomingRequestCount > 0 ? 'block' : 'none'; }); }
        window.dismissNotification = (notificationId) => { db.ref(`requests/${currentUser.uid}/${notificationId}`).remove(); };
        window.handleFriendRequest = (fromUid, accepted) => { db.ref(`requests/${currentUser.uid}/${fromUid}`).remove(); const notification = { name: currentUser.name, emoji: currentUser.emoji, type: accepted ? 'accepted' : 'rejected' }; db.ref(`requests/${fromUid}/${currentUser.uid}`).set(notification); if (accepted) { db.ref(`users/${currentUser.uid}/contacts/${fromUid}`).set(true); db.ref(`users/${fromUid}/contacts/${currentUser.uid}`).set(true); } }
        function listenForContacts() { db.ref(`users/${currentUser.uid}/contacts`).on('value', snapshot => { const list = document.getElementById('contact-list'); list.innerHTML = ''; if(snapshot.exists()){ snapshot.forEach(childSnapshot => { db.ref(`users/${childSnapshot.key}`).once('value', userSnap => { const contact = userSnap.val(); if(!contact) return; const div = document.createElement('div'); div.className = 'list-item'; div.onclick = () => openChat(childSnapshot.key, contact); div.innerHTML = `<div class="list-item-emoji">${contact.emoji}</div><div class="list-item-details"><div class="list-item-name">${contact.name}</div><div class="list-item-subtext" id="unread-count-${getChatId(currentUser.uid, childSnapshot.key)}">Click to open chat</div></div>`; list.appendChild(div); }); }); } else { list.innerHTML = '<p style="text-align:center; color: #667781; padding: 40px 20px;">Add friends to start chatting!</p>'; } }); }
        
        // --- MESSAGING & UNREAD --- (Unchanged)
        document.getElementById('chat-send-btn').addEventListener('click', sendMessage);
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        function sendMessage() { const input = document.getElementById('chat-input'); const text = input.value.trim(); if (!text || !currentChatPartner) return; if (currentChatPartner.blocked && currentChatPartner.blocked[currentUser.uid]) return alert("You have been blocked by this user."); const chatId = getChatId(currentUser.uid, currentChatPartner.uid); db.ref(`messages/${chatId}`).push({ text: text, sender: currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP }); db.ref(`unreadCounts/${currentChatPartner.uid}/${chatId}`).transaction(count => (count || 0) + 1); input.value = ''; }
        function listenForUnreadMessages() { db.ref(`unreadCounts/${currentUser.uid}`).on('value', snapshot => { let totalUnread = 0; snapshot.forEach(chatSnap => { const count = chatSnap.val(); totalUnread += count; const unreadElem = document.getElementById(`unread-count-${chatSnap.key}`); if (unreadElem) unreadElem.textContent = count > 0 ? `${count} new message${count > 1 ? 's' : ''}` : 'Click to open chat'; }); const badge = document.getElementById('home-badge'); badge.textContent = totalUnread; badge.style.display = totalUnread > 0 ? 'block' : 'none'; }); }

        // --- WEBRTC CALLING with BEAUTY FILTER ---
        document.getElementById('video-call-btn').addEventListener('click', () => startCall(true));
        document.getElementById('voice-call-btn').addEventListener('click', () => startCall(false));
        function drawVideoToCanvas() {
            if (localVideoHidden.paused || localVideoHidden.ended) return;
            canvasCtx.filter = 'brightness(1.05) contrast(1.05) saturate(1.1)'; // Apply beauty filter
            canvasCtx.drawImage(localVideoHidden, 0, 0, localVideoCanvas.width, localVideoCanvas.height);
            canvasCtx.filter = 'none'; // Reset filter
            animationFrameId = requestAnimationFrame(drawVideoToCanvas);
        }
        async function startCall(isVideo) {
            if (!currentChatPartner || (currentUser.blocked && currentUser.blocked[currentChatPartner.uid])) return alert(`You cannot call a blocked user.`);
            currentCallData = { id: db.ref('calls').push().key, isVideo, caller: { uid: currentUser.uid, ...currentUser }, calleeId: currentChatPartner.uid };
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
                if (isVideo) { localVideoHidden.srcObject = localStream; localVideoHidden.play(); localVideoHidden.onloadedmetadata = () => { localVideoCanvas.width = localVideoHidden.videoWidth; localVideoCanvas.height = localVideoHidden.videoHeight; drawVideoToCanvas(); }; canvasStream = localVideoCanvas.captureStream(30); localStream.getAudioTracks().forEach(track => canvasStream.addTrack(track)); }
                peerConnection = new RTCPeerConnection(stunServers);
                const streamToSend = isVideo ? canvasStream : localStream;
                streamToSend.getTracks().forEach(track => peerConnection.addTrack(track, streamToSend));
                peerConnection.onicecandidate = e => { if (e.candidate) db.ref(`iceCandidates/${currentCallData.id}/caller`).push(e.candidate.toJSON()); };
                peerConnection.ontrack = e => { remoteStream = e.streams[0]; document.getElementById(isVideo ? 'remote-video' : 'remote-audio').srcObject = remoteStream; };
                const offer = await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer);
                await db.ref(`calls/${currentCallData.calleeId}`).set({ ...currentCallData, offer: { type: offer.type, sdp: offer.sdp }});
                listenForCallAnswer(currentCallData.id); showCallUI(isVideo, 'Calling...');
            } catch (error) { console.error("Error starting call: ", error); alert("Could not start call. Check permissions."); cleanupCall(); }
        }
        document.getElementById('accept-call-btn').addEventListener('click', async () => {
            showModal('incoming-call-modal', false); ringtone.pause(); ringtone.currentTime = 0;
            const { isVideo, id: callId, offer } = currentCallData;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
                if (isVideo) { localVideoHidden.srcObject = localStream; localVideoHidden.play(); localVideoHidden.onloadedmetadata = () => { localVideoCanvas.width = localVideoHidden.videoWidth; localVideoCanvas.height = localVideoHidden.videoHeight; drawVideoToCanvas(); }; canvasStream = localVideoCanvas.captureStream(30); localStream.getAudioTracks().forEach(track => canvasStream.addTrack(track)); }
                peerConnection = new RTCPeerConnection(stunServers);
                const streamToSend = isVideo ? canvasStream : localStream;
                streamToSend.getTracks().forEach(track => peerConnection.addTrack(track, streamToSend));
                peerConnection.onicecandidate = e => { if (e.candidate) db.ref(`iceCandidates/${callId}/callee`).push(e.candidate.toJSON()); };
                peerConnection.ontrack = e => { remoteStream = e.streams[0]; document.getElementById(isVideo ? 'remote-video' : 'remote-audio').srcObject = remoteStream; };
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer(); await peerConnection.setLocalDescription(answer);
                await db.ref(`calls/${currentUser.uid}`).update({ answer: { type: answer.type, sdp: answer.sdp }});
                listenForRemoteIceCandidates(callId, 'caller'); showCallUI(isVideo, 'Connected');
            } catch(error) { console.error("Error accepting call:", error); alert("Could not accept call."); cleanupCall(); }
        });
        function showCallUI(isVideo, status) { const viewId = isVideo ? 'video-call-view' : 'voice-call-view'; const callerInfo = document.getElementById(isVideo ? 'video-caller-info' : 'voice-caller-info'); const contact = currentCallData.caller.uid === currentUser.uid ? currentChatPartner : currentCallData.caller; callerInfo.querySelector('.emoji').textContent = contact.emoji; callerInfo.querySelector('.name').textContent = contact.name; callerInfo.querySelector('.status').textContent = status; showView(viewId); }
        function cleanupCall() { if (peerConnection) { peerConnection.close(); peerConnection = null; } if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; } cancelAnimationFrame(animationFrameId); canvasCtx.clearRect(0, 0, localVideoCanvas.width, localVideoCanvas.height); document.getElementById('remote-audio').srcObject = null; document.getElementById('remote-video').srcObject = null; if (currentCallData) { const otherUserId = currentCallData.caller.uid === currentUser.uid ? currentCallData.calleeId : currentCallData.caller.uid; db.ref(`calls/${otherUserId}`).remove(); db.ref(`calls/${currentUser.uid}`).remove(); db.ref(`iceCandidates/${currentCallData.id}`).remove(); } currentCallData = null; showView('chat-view'); }
        function listenForCallAnswer(callId) { db.ref(`calls/${currentCallData.calleeId}`).on('value', async snapshot => { const data = snapshot.val(); if (data && data.answer && peerConnection.signalingState !== "stable") { await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer)); listenForRemoteIceCandidates(callId, 'callee'); updateCallStatus('Connected'); } else if (!data) { endCall(); }}); }
        function listenForIncomingCalls() { db.ref(`calls/${currentUser.uid}`).on('value', async snapshot => { const callData = snapshot.val(); if(callData && !currentCallData) { if (currentUser.blocked && currentUser.blocked[callData.caller.uid]) { db.ref(`calls/${currentUser.uid}`).remove(); return; } currentCallData = callData; document.getElementById('incoming-caller-info').innerHTML = `<div class="emoji">${callData.caller.emoji}</div><div class="name">${callData.caller.name}</div><p style="margin-top: 5px;">Incoming ${callData.isVideo ? 'Video' : 'Voice'} Call</p>`; showModal('incoming-call-modal'); ringtone.play(); } }); }
        document.getElementById('reject-call-btn').addEventListener('click', () => { showModal('incoming-call-modal', false); ringtone.pause(); ringtone.currentTime = 0; db.ref(`calls/${currentUser.uid}`).remove(); logCall('rejected'); currentCallData = null; });
        function listenForRemoteIceCandidates(callId, role) { db.ref(`iceCandidates/${callId}/${role}`).on('child_added', s => { if (s.exists()) peerConnection.addIceCandidate(new RTCIceCandidate(s.val())); }); }
        function updateCallStatus(status) { const viewId = currentCallData.isVideo ? 'video-call-view' : 'voice-call-view'; const statusElem = document.querySelector(`#${viewId} .status`); if(statusElem) statusElem.textContent = status; }
        document.getElementById('end-video-call-btn').addEventListener('click', endCall); document.getElementById('end-voice-call-btn').addEventListener('click', endCall);
        function endCall() { logCall('ended'); cleanupCall(); }
        function logCall(status) { if (!currentCallData) return; const partner = currentCallData.caller.uid === currentUser.uid ? currentChatPartner : currentCallData.caller; if(!partner) return; db.ref(`callLogs/${currentUser.uid}`).push({ partnerName: partner.name, partnerEmoji: partner.emoji, type: currentCallData.isVideo ? 'video' : 'voice', status, timestamp: firebase.database.ServerValue.TIMESTAMP }); }
        function renderCallLogs() { const list = document.getElementById('call-log-list'); db.ref(`callLogs/${currentUser.uid}`).orderByChild('timestamp').limitToLast(30).on('value', snapshot => { list.innerHTML = ''; if (!snapshot.exists()) { list.innerHTML = '<p style="text-align:center; color: #667781; padding: 40px 20px;">No recent calls.</p>'; return; } const logs = []; snapshot.forEach(child => logs.push(child.val())); logs.reverse().forEach(log => { const div = document.createElement('div'); div.className = 'list-item'; div.innerHTML = `<div class="list-item-emoji">${log.partnerEmoji}</div> <div class="list-item-details"> <div class="list-item-name">${log.partnerName} (${log.type})</div> <div class="list-item-subtext">${log.status} - ${new Date(log.timestamp).toLocaleString()}</div> </div>`; list.appendChild(div); }); }); }
        
        // --- PROFILE & BLOCKING ---
        function showProfileModal() { document.getElementById('profile-info-display').innerHTML = `<p><strong>Name:</strong> ${currentUser.name}</p><p><strong>Emoji:</strong> ${currentUser.emoji}</p><p><strong>ID:</strong> ${currentUser.jgId}</p>`; document.getElementById('edit-profile-name').value = currentUser.name; document.getElementById('edit-profile-emoji').value = currentUser.emoji; document.getElementById('profile-info-display').style.display = 'block'; document.getElementById('profile-edit-form').style.display = 'none'; document.getElementById('edit-profile-btn').style.display = 'inline-block'; document.getElementById('save-profile-changes-btn').style.display = 'none'; renderBlockedUsers(); showModal('profile-view-modal'); }
        document.getElementById('close-profile-modal-btn').addEventListener('click', () => showModal('profile-view-modal', false));
        document.getElementById('edit-profile-btn').addEventListener('click', () => { document.getElementById('profile-info-display').style.display = 'none'; document.getElementById('profile-edit-form').style.display = 'block'; document.getElementById('edit-profile-btn').style.display = 'none'; document.getElementById('save-profile-changes-btn').style.display = 'inline-block'; });
        document.getElementById('save-profile-changes-btn').addEventListener('click', () => { db.ref(`users/${currentUser.uid}`).update({ name: document.getElementById('edit-profile-name').value, emoji: document.getElementById('edit-profile-emoji').value }); showProfileModal(); });
        document.getElementById('chat-more-btn').addEventListener('click', () => { if(!currentChatPartner) return; showConfirmModal(`Are you sure you want to block ${currentChatPartner.name}?`, () => blockUser(currentChatPartner.uid) ); });
        function blockUser(uidToBlock) { db.ref(`users/${currentUser.uid}/blocked/${uidToBlock}`).set(true).then(() => { alert('User blocked.'); db.ref(`users/${currentUser.uid}/contacts/${uidToBlock}`).remove(); showView('main-view'); }); }
        window.unblockUser = (uidToUnblock) => { db.ref(`users/${currentUser.uid}/blocked/${uidToUnblock}`).remove().then(() => { alert('User unblocked.'); renderBlockedUsers(); }); }
        function renderBlockedUsers() { const list = document.getElementById('blocked-users-list'); list.innerHTML = ''; db.ref(`users/${currentUser.uid}/blocked`).once('value', snapshot => { if (!snapshot.exists()) { list.innerHTML = '<p style="font-size:12px; text-align:center; color: #667781;">No users blocked.</p>'; return; } snapshot.forEach(childSnapshot => { db.ref(`users/${childSnapshot.key}`).once('value', userSnap => { if (userSnap.exists()) { const user = userSnap.val(); const item = document.createElement('div'); item.className = 'list-item'; item.innerHTML = `<div class="list-item-emoji" style="font-size: 24px;">${user.emoji}</div><div class="list-item-details"><div class="list-item-name">${user.name}</div></div><div class="list-item-actions"><button onclick="unblockUser('${childSnapshot.key}')">Unblock</button></div>`; list.appendChild(item); } }); }); }); }
        
        // --- YOUTUBE PLAYER SETUP ---
        const YOUTUBE_API_KEY = "AIzaSyA6qNE-wCpW1oAkH7mPyVkezmbHrK8QXN8";
        function onYouTubeIframeAPIReady() { 
            musicPlayer = new YT.Player('music-player-container', { height: '1', width: '1', playerVars: { 'autoplay': 0, 'controls': 0 } });
            videoWatchPlayer = new YT.Player('video-watch-player', { height: '100%', width: '100%', playerVars: { 'autoplay': 0, 'controls': 1, 'rel': 0 }, events: { 'onStateChange': onVideoWatchPlayerStateChange, 'onReady': onVideoWatchPlayerReady } });
        }

        // --- MUSIC SYNC --- (Largely unchanged)
        function initMusicSync(chatId) {
            db.ref(`musicState/${chatId}`).on('value', (snapshot) => {
                if (!musicPlayer || document.getElementById('chat-view').style.display === 'none') return;
                const state = snapshot.val();
                if (state && state.songId) {
                    document.getElementById('music-player-bar').style.display = 'block';
                    document.getElementById('music-title').textContent = state.title;
                    document.getElementById('music-thumbnail').src = state.thumbnail;
                    if (musicPlayer.getVideoData().video_id !== state.songId) { musicPlayer.loadVideoById(state.songId, state.currentTime); }
                    const playIcon = document.getElementById('play-icon'); const pauseIcon = document.getElementById('pause-icon');
                    if (state.isPlaying && musicPlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
                        musicPlayer.seekTo(state.currentTime, true); musicPlayer.playVideo(); playIcon.style.display = 'none'; pauseIcon.style.display = 'block';
                    } else if (!state.isPlaying && musicPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                        musicPlayer.pauseVideo(); playIcon.style.display = 'block'; pauseIcon.style.display = 'none';
                    }
                } else { document.getElementById('music-player-bar').style.display = 'none'; if (musicPlayer && typeof musicPlayer.stopVideo === 'function') musicPlayer.stopVideo(); }
            });
            clearInterval(musicUpdateInterval);
            musicUpdateInterval = setInterval(() => {
                if (!musicPlayer || !currentChatId || typeof musicPlayer.getPlayerState !== 'function') return;
                const playerState = musicPlayer.getPlayerState();
                if (playerState === YT.PlayerState.PLAYING) { const currentTime = musicPlayer.getCurrentTime(); const duration = musicPlayer.getDuration(); if (duration > 0) document.getElementById('music-progress-bar').style.width = (currentTime / duration) * 100 + '%'; }
            }, 500);
        }
        function updateMusicState(newState) { if (!currentChatId) return; const update = { ...newState, lastUpdatedBy: currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP }; db.ref(`musicState/${currentChatId}`).update(update); }
        document.getElementById('music-play-pause-btn').addEventListener('click', () => { if (!musicPlayer || typeof musicPlayer.getPlayerState !== 'function') return; const isPlaying = musicPlayer.getPlayerState() === YT.PlayerState.PLAYING; updateMusicState({ isPlaying: !isPlaying, currentTime: musicPlayer.getCurrentTime() }); });
        document.getElementById('music-progress-container').addEventListener('click', function(e) { if (!musicPlayer || typeof musicPlayer.getDuration !== 'function') return; const duration = musicPlayer.getDuration(); if(!duration) return; const rect = this.getBoundingClientRect(); const x = e.clientX - rect.left; const width = this.offsetWidth; const newTime = (x / width) * duration; musicPlayer.seekTo(newTime, true); updateMusicState({ currentTime: newTime, isPlaying: true }); });
        document.getElementById('music-remove-btn').addEventListener('click', () => { if(currentChatId) db.ref(`musicState/${currentChatId}`).remove(); });

        // --- VIDEO WATCH SYNC ---
        let lastStateChangeByRemote = false;
        function onVideoWatchPlayerReady(event) {
             setInterval(() => {
                if(videoWatchPlayer && typeof videoWatchPlayer.getPlayerState === 'function' && videoWatchPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                    db.ref(`videoState/${currentChatId}`).update({ currentTime: videoWatchPlayer.getCurrentTime() });
                }
            }, 1000);
        }
        function onVideoWatchPlayerStateChange(event) {
            if (lastStateChangeByRemote) { lastStateChangeByRemote = false; return; }
            let isPlaying = (event.data === YT.PlayerState.PLAYING);
            db.ref(`videoState/${currentChatId}`).update({ isPlaying: isPlaying, currentTime: videoWatchPlayer.getCurrentTime() });
        }
        function initVideoWatchSync(chatId) {
            db.ref(`videoState/${chatId}`).on('value', (snapshot) => {
                if (!videoWatchPlayer || document.getElementById('video-watch-view').style.display === 'none') return;
                const state = snapshot.val();
                if (state && state.videoId) {
                    document.getElementById('video-watch-title').textContent = state.title;
                    if (videoWatchPlayer.getVideoData().video_id !== state.videoId) {
                        lastStateChangeByRemote = true;
                        videoWatchPlayer.loadVideoById(state.videoId, state.currentTime);
                    }
                    const playerState = videoWatchPlayer.getPlayerState();
                    const timeDiff = Math.abs(videoWatchPlayer.getCurrentTime() - state.currentTime);

                    if (state.isPlaying && playerState !== YT.PlayerState.PLAYING) {
                        lastStateChangeByRemote = true;
                        if(timeDiff > 2) videoWatchPlayer.seekTo(state.currentTime, true);
                        videoWatchPlayer.playVideo();
                    } else if (!state.isPlaying && playerState === YT.PlayerState.PLAYING) {
                        lastStateChangeByRemote = true;
                        videoWatchPlayer.pauseVideo();
                    }
                }
            });
        }
        document.getElementById('close-watch-view-btn').addEventListener('click', () => { showView('chat-view'); db.ref(`videoState/${currentChatId}`).remove(); });
        document.getElementById('fullscreen-btn').addEventListener('click', () => { 
            const elem = document.getElementById('video-watch-view');
            elem.classList.toggle('fullscreen');
            if (!document.fullscreenElement) { elem.requestFullscreen().catch(err => console.error(err)); } 
            else { document.exitFullscreen(); }
        });
        document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement) document.getElementById('video-watch-view').classList.remove('fullscreen'); });
        
        // --- REACTION SYSTEM ---
        document.getElementById('reaction-bar').addEventListener('click', (e) => {
            if(e.target.tagName === 'BUTTON' && currentChatId) {
                db.ref(`reactions/${currentChatId}`).push(e.target.textContent);
            }
        });
        function listenForReactions(chatId) {
            db.ref(`reactions/${chatId}`).limitToLast(5).on('child_added', (snapshot) => {
                const emoji = snapshot.val();
                const container = document.getElementById('reaction-container');
                const emojiEl = document.createElement('div');
                emojiEl.className = 'reaction-emoji';
                emojiEl.textContent = emoji;
                container.appendChild(emojiEl);
                setTimeout(() => emojiEl.remove(), 2000); // Remove after animation
            });
        }

        // --- UNIVERSAL SEARCH ---
        document.getElementById('music-search-btn').addEventListener('click', () => { searchType = 'music'; document.getElementById('search-input').placeholder = "Search for a song..."; showModal('search-modal'); });
        document.getElementById('movie-search-btn').addEventListener('click', () => { searchType = 'movie'; document.getElementById('search-input').placeholder = "Search for a video..."; showModal('search-modal'); });
        document.getElementById('close-search-modal-btn').addEventListener('click', () => showModal('search-modal', false));
        document.getElementById('search-input').addEventListener('input', (e) => { if (e.target.value.length > 2) searchYoutube(e.target.value); });
        async function searchYoutube(query) { const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${query}&type=video&maxResults=10&key=${YOUTUBE_API_KEY}`; try { const response = await fetch(url); const data = await response.json(); displaySearchResults(data.items); } catch (error) { console.error('Error fetching from YouTube API:', error); } }
        function displaySearchResults(items) {
            const resultsContainer = document.getElementById('search-results'); resultsContainer.innerHTML = ''; if(!items) return;
            items.forEach(item => {
                const resultDiv = document.createElement('div'); resultDiv.className = 'suggestion-item';
                resultDiv.innerHTML = `<img src="${item.snippet.thumbnails.default.url}" alt="thumbnail"> <span>${item.snippet.title}</span>`;
                resultDiv.onclick = () => {
                    if (searchType === 'music') {
                        updateMusicState({ songId: item.id.videoId, title: item.snippet.title, thumbnail: item.snippet.thumbnails.default.url, isPlaying: true, currentTime: 0 });
                    } else { // movie
                        db.ref(`videoState/${currentChatId}`).set({ videoId: item.id.videoId, title: item.snippet.title, isPlaying: true, currentTime: 0, startedBy: currentUser.uid });
                        showView('video-watch-view');
                    }
                    showModal('search-modal', false);
                };
                resultsContainer.appendChild(resultDiv);
            });
        }
    </script>
</body>
</html>
